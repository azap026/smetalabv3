# Smetalab v1.0.2

A SaaS application built with **Next.js**, featuring authentication, Stripe payment integration, and team management dashboard.

**Repository: [https://github.com/azap026/smetalabv3](https://github.com/azap026/smetalabv3)**

## Features

- Marketing landing page (`/`) with animated Terminal element
- Pricing page (`/pricing`) which connects to Stripe Checkout
- Dashboard pages with CRUD operations on users/teams
- **Advanced RBAC (Role-Based Access Control)** with platform and tenant roles
- Subscription management with Stripe Customer Portal
- Email/password authentication with JWTs stored to cookies
- Global middleware to protect logged-in routes
- Local middleware to protect Server Actions or validate Zod schemas
- Activity logging system for any user events
- Admin dashboard with permissions matrix UI

## Role-Based Access Control (RBAC)

### Role Types

**Platform Roles** (for platform-level access):
| Role | Description |
|------|-------------|
| `superadmin` | Full platform access, can impersonate tenants |
| `support` | Limited platform access for customer support |

**Tenant Roles** (for team-level access):
| Role | Description |
|------|-------------|
| `admin` | Full team access, can manage members and billing |
| `estimator` | Create and edit estimates, view projects |
| `manager` | Manage materials and purchases, view-only estimates |

### Usage

**Server-side (API routes, Server Components):**
```typescript
import { checkAccess, isSuperadmin } from '@/lib/auth/access';

// Check specific permission
const { authorized } = await checkAccess('estimates.create', tenantId);

// Check if superadmin
if (await isSuperadmin()) { /* ... */ }
```

**Client-side (React components):**
```typescript
import { usePermissions } from '@/hooks/use-permissions';

function MyComponent() {
  const { hasPermission, loading } = usePermissions();
  
  if (hasPermission('estimates.create')) {
    return <CreateButton />;
  }
}
```

### Seeding Permissions

```bash
# Seed permissions and role mappings
pnpm db:seed:permissions
```

## Tech Stack

- **Framework**: [Next.js](https://nextjs.org/)
- **Database**: [Postgres](https://www.postgresql.org/)
- **ORM**: [Drizzle](https://orm.drizzle.team/)
- **Payments**: [Stripe](https://stripe.com/)
- **UI Library**: [shadcn/ui](https://ui.shadcn.com/)

## Getting Started

```bash
git clone https://github.com/azap026/smetalabv3
cd "Smetalab v1.0.2"
pnpm install
```

## Environment Setup

Create a `.env` file based on `.env.example`:

```bash
cp .env.example .env
```

Fill in the required values:

- `POSTGRES_URL`: Your Render Postgres connection string (Frankfurt region)
- `BASE_URL`: `http://localhost:3000` for local dev
- `AUTH_SECRET`: Generate with `node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"`
- `STRIPE_SECRET_KEY`: From [Stripe Dashboard](https://dashboard.stripe.com/test/apikeys)
- `STRIPE_WEBHOOK_SECRET`: Generated by Stripe CLI (see below)
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`: From [Stripe Dashboard](https://dashboard.stripe.com/test/apikeys)

## Running Locally

### 1. Install Stripe CLI

Download Stripe CLI for local development:

```bash
# Using Chocolatey (Windows)
choco install stripe-cli

# Or download manually from: https://docs.stripe.com/stripe-cli
```

Login to Stripe:

```bash
stripe login
```

### 2. Setup Database

Push the schema to your database:

```bash
pnpm db:migrate
```

Optionally seed with test data:

```bash
pnpm db:seed
```

Default user credentials:
- Email: `test@test.com`
- Password: `admin123`

### 3. Start the development server

```bash
pnpm dev
```

### 4. Listen for Stripe webhooks

In a separate terminal, start the Stripe webhook listener:

```bash
stripe listen --forward-to localhost:3000/api/stripe/webhook
```

Copy the webhook signing secret (`whsec_...`) and add it to your `.env` as `STRIPE_WEBHOOK_SECRET`.

Open [http://localhost:3000](http://localhost:3000) to view the application.

## Testing Payments

To test Stripe payments, use the following test card details:

- Card Number: `4242 4242 4242 4242`
- Expiration: Any future date
- CVC: Any 3-digit number

## CI/CD with GitHub Actions

This project includes automated CI/CD pipeline that runs on every push and pull request to `main`:

- **Linting**: Checks code style with ESLint
- **Type checking**: Validates TypeScript types
- **Build**: Ensures the project builds successfully

### Setting up GitHub Secrets

For CI to work, add these secrets in your GitHub repository settings (`Settings > Secrets and variables > Actions`):

1. `POSTGRES_URL` - Your production/staging database URL
2. `STRIPE_SECRET_KEY` - Stripe secret key
3. `STRIPE_WEBHOOK_SECRET` - Stripe webhook secret
4. `AUTH_SECRET` - Authentication secret
5. `BASE_URL` - Your deployment URL

## Going to Production

When you're ready to deploy your SaaS application to production, follow these steps:

### Set up a production Stripe webhook

1. Go to the Stripe Dashboard and create a new webhook for your production environment.
2. Set the endpoint URL to your production API route (e.g., `https://yourdomain.com/api/stripe/webhook`).
3. Select the events you want to listen for (e.g., `checkout.session.completed`, `customer.subscription.updated`).

### Deploy to Vercel

1. Push your code to a GitHub repository.
2. Connect your repository to [Vercel](https://vercel.com/) and deploy it.
3. Follow the Vercel deployment process, which will guide you through setting up your project.

### Add environment variables

In your Vercel project settings (or during deployment), add all the necessary environment variables. Make sure to update the values for the production environment, including:

1. `BASE_URL`: Set this to your production domain.
2. `STRIPE_SECRET_KEY`: Use your Stripe secret key for the production environment.
3. `STRIPE_WEBHOOK_SECRET`: Use the webhook secret from the production webhook you created in step 1.
4. `POSTGRES_URL`: Set this to your production database URL.
5. `AUTH_SECRET`: Set this to a random string. `openssl rand -base64 32` will generate one.
6. `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`: Your Stripe publishable key for production.

## Other Templates

While this template is intentionally minimal and to be used as a learning resource, there are other paid versions in the community which are more full-featured:

- https://achromatic.dev
- https://shipfa.st
- https://makerkit.dev
- https://zerotoshipped.com
- https://turbostarter.dev
